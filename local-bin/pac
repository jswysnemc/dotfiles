#!/bin/bash

# ==============================================================================
# pac - Fuzzy search and install packages (Custom Keybindings)
# ==============================================================================
set -o pipefail

# --- 1. Pre-Configuration ---
ORIGINAL_LANG="${LC_ALL:-${LC_MESSAGES:-${LANG}}}"
SHOW_HELP=false
QUERY_ARGS=""

# --- 2. Argument Parsing ---
while [[ $# -gt 0 ]]; do
    case "$1" in
        --help|-h)
            SHOW_HELP=true
            shift
            ;;
        *)
            QUERY_ARGS="$QUERY_ARGS $1"
            shift
            ;;
    esac
done
QUERY_ARGS="${QUERY_ARGS# }"

# --- 3. Auto-Detect Language ---
if [[ "$ORIGINAL_LANG" == *"zh_CN"* ]]; then
    UI_LANG="zh"
else
    UI_LANG="en"
fi

# --- 4. Helper Detection ---
if command -v paru >/dev/null 2>&1; then
    AUR_HELPER="paru"
elif command -v yay >/dev/null 2>&1; then
    AUR_HELPER="yay"
else
    AUR_HELPER=""
fi

# --- 5. Environment Setup ---
export LC_ALL=C

# --- 6. Colors ---
COLOR_OFF='\033[34m'
COLOR_AUR='\033[35m'
COLOR_INST='\033[32m'
COLOR_RESET='\033[0m'

# --- 7. Localization ---
LANG_TABLE='
MSG_USAGE_DESC    | Fuzzy search & install packages (Repo + AUR).              | 模糊搜索并安装软件包 (支持官方源和 AUR)。
MSG_USAGE_FEAT    | Features:                                                  | 功能特性：
MSG_USAGE_EX      | Example:                                                   | 示例：
MSG_ERR_FZF       | Error: fzf not found.                                      | 错误：未找到 fzf。
MSG_ERR_HELPER    | Error: Neither paru nor yay found.                         | 错误：未找到 paru 或 yay。
MSG_ERR_CURL      | Error: curl/gzip not found (needed for AUR list).          | 错误：未找到 curl/gzip (用于获取 AUR 列表)。
MSG_INSTALLED     | [Installed]                                                | [已安装]
MSG_INSTALLING    | >> Installing with                                         | >> 准备安装，使用工具：
FZF_HEADER        | Tab/Space:Select | Enter:Install | Esc:Exit                | Tab/Space:多选 | Enter:安装 | Esc:退出
'

while IFS='|' read -r v e c; do
    v=$(printf '%s' "$v" | sed 's/^ *//;s/ *$//')
    e=$(printf '%s' "$e" | sed 's/^ *//;s/ *$//')
    c=$(printf '%s' "$c" | sed 's/^ *//;s/ *$//')
    [ -z "$v" ] && continue
    case "$v" in \#*) continue ;; esac

    if [ "$UI_LANG" = "zh" ]; then
        eval "$v=\"$c\""
    else
        eval "$v=\"$e\""
    fi
done <<EOF
$LANG_TABLE
EOF

# --- 8. Help Function ---
if [ "$SHOW_HELP" = true ]; then
    cat <<EOF
Usage: pac [options] [query]
Description: $MSG_USAGE_DESC
EOF
    exit 0
fi

# --- 9. Dependency Check ---
command -v fzf >/dev/null 2>&1 || { echo "$MSG_ERR_FZF" >&2; exit 1; }
if [ -z "$AUR_HELPER" ]; then echo "$MSG_ERR_HELPER" >&2; exit 1; fi
if [ "$AUR_HELPER" = "paru" ] && ! command -v yay >/dev/null 2>&1; then
    command -v curl >/dev/null 2>&1 && command -v gzip >/dev/null 2>&1 || { echo "$MSG_ERR_CURL" >&2; exit 1; }
fi

# --- 10. Async Logic Setup ---
AUR_FILTER='^(mingw-|lib32-|cross-|.*-debug$)'
PREVIEW_CMD="$AUR_HELPER -Si {2}"
TARGET_FILE=$(mktemp -t pac_fzf.XXXXXX)
INSTALLED_LIST=$(mktemp -t pac_installed.XXXXXX)
PIPE_FIFO=$(mktemp -u)
mkfifo "$PIPE_FIFO"

# Cleanup
cleanup() {
    if [ -n "$PID_GEN" ]; then kill "$PID_GEN" 2>/dev/null; fi
    rm -f "$TARGET_FILE" "$INSTALLED_LIST" "$PIPE_FIFO"
}
trap cleanup EXIT INT TERM

# Cache installed list
pacman -Qq > "$INSTALLED_LIST"

# --- 11. Data Generation (Background) ---
AWK_CMD='
    FNR==NR { installed[$1]=1; next }
    {
        ver = ($3 == "-" || $3 == "") ? "" : $3
        status = ($2 in installed) ? ci " ✔ " label r : ""
        printf "%s%-10s%s %-30s %-15s %s\n", c, $1, r, $2, ver, status
    }
'

(
    # Repo
    pacman -Sl | awk -v c="$COLOR_OFF" -v ci="$COLOR_INST" -v r="$COLOR_RESET" \
        -v label="$MSG_INSTALLED" "$AWK_CMD" "$INSTALLED_LIST" -
    # AUR
    if command -v yay >/dev/null 2>&1; then
        yay -Sl aur | grep -vE "$AUR_FILTER" | \
            awk -v c="$COLOR_AUR" -v ci="$COLOR_INST" -v r="$COLOR_RESET" \
            -v label="$MSG_INSTALLED" "$AWK_CMD" "$INSTALLED_LIST" -
    else
        curl -sL "https://aur.archlinux.org/packages.gz" | gzip -d | \
            grep -vE "$AUR_FILTER" | awk '{print "aur", $1, "-", "-"}' | \
            awk -v c="$COLOR_AUR" -v ci="$COLOR_INST" -v r="$COLOR_RESET" \
            -v label="$MSG_INSTALLED" "$AWK_CMD" "$INSTALLED_LIST" -
    fi
) > "$PIPE_FIFO" 2>/dev/null &

PID_GEN=$!

# --- 12. Interactive FZF ---

# 这里的 --bind 是关键
# tab:down        -> Tab 键只向下移动 (不选中)
# btab:up         -> Shift+Tab 向上移动
# space:toggle+down -> 空格键 选中并下移

fzf --multi --ansi \
    --bind 'tab:down,btab:up,space:toggle+down' \
    --preview "$PREVIEW_CMD" \
    --preview-window=right:50%:wrap \
    --tiebreak=index \
    --nth=2 \
    --header "$FZF_HEADER" \
    --query "$QUERY_ARGS" \
    < "$PIPE_FIFO" \
    > "$TARGET_FILE"

# --- 13. Execution ---
if [ -s "$TARGET_FILE" ]; then
    PACKAGES=$(awk '{print $2}' "$TARGET_FILE" | tr '\n' ' ')
    if [ -n "$PACKAGES" ]; then
        echo -e "\n${COLOR_INST}${MSG_INSTALLING} ${AUR_HELPER}...${COLOR_RESET}"
        echo "$PACKAGES"
        echo "----------------------------------------"
        $AUR_HELPER -S $PACKAGES
    fi
fi

