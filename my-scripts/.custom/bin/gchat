#!/usr/bin/env bash
# ==============================================================================
# gchat v2.7: äº¤äº’å¼ã€æ”¯æŒæµå¼å¯¹è¯ã€å†å²è®°å½•å’Œä¼šè¯ç®¡ç†çš„ Shell AI èŠå¤©åŠ©æ‰‹
# ä½œè€…: Gemini
# ç‰ˆæœ¬: 2.7 (Markdown-first è¾“å‡º)
# ==============================================================================

# --- é…ç½®åŒºåŸŸ ---
API_URL="${G_API_URL:-"https://gemini.snemc.top/v1/chat/completions"}"
API_KEY="${G_API_KEY:-"gemini-key"}"
MODEL="${G_TEXT_MODEL:-"gemini-2.5-flash"}"
TEMPERATURE=0.5

# --- å­˜å‚¨é…ç½® ---
STORAGE_DIR="$HOME/.local/share/gchat"
SESSIONS_DIR="$STORAGE_DIR/sessions"
CURRENT_SESSION_POINTER="$STORAGE_DIR/current_session_path"
SYSTEM_PROMPT_FILE="$STORAGE_DIR/system_prompt.txt"
HISTORY_FILE=""

# --- Markdown æ¸²æŸ“å™¨ ---
MD_RENDERER="" # å°†åœ¨ detect_markdown_renderer ä¸­è®¾ç½®

# --- TUI ç¾åŒ–ä¸é¢œè‰²é…ç½® ---
if [[ -t 1 && "${TERM}" != "dumb" && "$(tput colors 2>/dev/null)" -ge 8 ]]; then
    COLOR_USER=$(tput setaf 2)   # Green
    COLOR_AI=$(tput setaf 4)     # Blue
    COLOR_CMD=$(tput setaf 8)    # Grey
    COLOR_BORDER=$(tput setaf 8) # Grey
    COLOR_RESET=$(tput sgr0)
else
    COLOR_USER="" COLOR_AI="" COLOR_CMD="" COLOR_BORDER="" COLOR_RESET=""
fi

PREFIX_USER="${COLOR_USER}â¤ ä½ :${COLOR_RESET}"
PREFIX_AI="${COLOR_AI}ğŸ¤– AI:${COLOR_RESET}"
PREFIX_SYSTEM="${COLOR_CMD}â„¹ï¸ gchat:${COLOR_RESET}"

# ==============================================================================
# æ ¸å¿ƒå‡½æ•°
# ==============================================================================

spinner() {
    local sp='â ‹â ™â ¹â ¸â ¼â ´â ¦â §â ‡â '; local delay=0.05
    while :; do printf "\b%s" "${sp:i++%${#sp}:1}"; sleep "$delay"; done
}

print_separator() {
    local width; width=$(tput cols 2>/dev/null || echo 80)
    printf "%s%s%s\n" "${COLOR_BORDER}" "$(printf 'â”€%.0s' $(seq 1 "$width"))" "${COLOR_RESET}"
}

usage() {
    echo "ç”¨æ³•: gchat [é€‰é¡¹] [ä¸´æ—¶æç¤º]"
    echo ""
    echo "  ç›´æ¥è¿è¡Œ 'gchat' è¿›å…¥å¸¦ä¼šè¯ç®¡ç†çš„äº¤äº’å¼èŠå¤©æ¨¡å¼ã€‚"
    echo "  gchat \"ä½ çš„é—®é¢˜\"   è¿›è¡Œä¸€æ¬¡æ€§çš„ä¸´æ—¶å¯¹è¯ï¼Œä¸ä¿å­˜å†å²è®°å½•ã€‚"
    echo "  cat file.txt | gchat  ä»ç®¡é“è¯»å–è¾“å…¥è¿›è¡Œä¸´æ—¶å¯¹è¯ã€‚"
    echo ""
    echo "é€‰é¡¹:"
    echo "  -h, --help      æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯å¹¶é€€å‡ºã€‚"
    echo "  -c, --clear     æ¸…é™¤å½“å‰æ´»åŠ¨ä¼šè¯çš„å¯¹è¯å†å²å¹¶é€€å‡ºã€‚"
    echo "  -s, --system    <æç¤º> è®¾ç½®ä¸€ä¸ªæ–°çš„ç³»ç»Ÿæç¤ºè¯å¹¶é€€å‡ºã€‚"
    echo "  -gs, --getsystem è·å–å½“å‰çš„ç³»ç»Ÿæç¤ºè¯å¹¶é€€å‡ºã€‚"
    exit 0
}

show_interactive_help() {
    print_separator
    echo "${PREFIX_SYSTEM} äº¤äº’æ¨¡å¼å¯ç”¨å‘½ä»¤:"
    echo "  /help                 - æ˜¾ç¤ºæ­¤å¸®åŠ©èœå•"
    echo "  /clear                - æ¸…é™¤å½“å‰ä¼šè¯çš„å¯¹è¯å†å²"
    echo "  /system <æ–°æç¤º>      - è®¾ç½®ä¸€ä¸ªæ–°çš„ç³»ç»Ÿæç¤ºè¯"
    echo "  /getsystem, /gs       - æŸ¥çœ‹å½“å‰çš„ç³»ç»Ÿæç¤ºè¯"
    echo "  /new                  - åˆ›å»ºå¹¶åˆ‡æ¢åˆ°ä¸€ä¸ªæ–°ä¼šè¯"
    echo "  /list, /ls            - åˆ—å‡ºæ‰€æœ‰å¯ç”¨ä¼šè¯"
    echo "  /switch               - åˆ‡æ¢åˆ°å…¶ä»–ä¼šè¯"
    echo "  /delete               - åˆ é™¤ä¸€ä¸ªä¼šè¯"
    echo "  /exit, /quit          - é€€å‡º gchat"
    print_separator
}

setup_environment() {
    mkdir -p "$SESSIONS_DIR"
    touch "$CURRENT_SESSION_POINTER"
    if [ ! -s "$SYSTEM_PROMPT_FILE" ]; then
        echo "ä½ æ˜¯ä¸€ä¸ªå¾—åŠ›çš„é€šç”¨AIåŠ©æ‰‹ã€‚" >"$SYSTEM_PROMPT_FILE"
    fi

    local current_session; current_session=$(cat "$CURRENT_SESSION_POINTER")
    if [ -z "$current_session" ] || [ ! -f "$current_session" ]; then
        new_session "initial"
    fi
    HISTORY_FILE=$(cat "$CURRENT_SESSION_POINTER")
}

check_dependencies() {
    for cmd in jq curl; do
        if ! command -v "$cmd" &>/dev/null; then
            echo "${PREFIX_SYSTEM} é”™è¯¯: å‘½ä»¤ '$cmd' æœªæ‰¾åˆ°ã€‚è¯·å®‰è£…åé‡è¯•ã€‚" >&2; exit 1
        fi
    done
}

detect_markdown_renderer() {
    if command -v mdcat &>/dev/null; then
        MD_RENDERER="mdcat"
    elif command -v glow &>/dev/null; then
        MD_RENDERER="glow"
    elif command -v bat &>/dev/null; then
        MD_RENDERER="bat -l md --style=plain"
    fi
}

# ==============================================================================
# ä¼šè¯ç®¡ç†å‡½æ•°
# ==============================================================================

new_session() {
    local new_session_file; new_session_file="${SESSIONS_DIR}/session_$(date +%s).json"
    touch "$new_session_file"; echo "$new_session_file" > "$CURRENT_SESSION_POINTER"
    HISTORY_FILE=$new_session_file
    if [ "$1" != "initial" ]; then clear; echo "${PREFIX_SYSTEM} å·²åˆ›å»ºå¹¶åˆ‡æ¢åˆ°æ–°ä¼šè¯ã€‚"; fi
}

list_sessions() {
    print_separator; echo "${PREFIX_SYSTEM} å¯ç”¨ä¼šè¯ (æŒ‰æœ€è¿‘ä½¿ç”¨æ’åº):"
    local sessions_list=();
    while IFS= read -r file; do [[ -n "$file" ]] && sessions_list+=("$file"); done < \
        <(find "$SESSIONS_DIR" -type f -name "*.json" -printf "%T@ %p\n" | sort -nr | cut -d' ' -f2-)

    if [ ${#sessions_list[@]} -eq 0 ]; then echo "  æ²¡æœ‰æ‰¾åˆ°ä»»ä½•ä¼šè¯ã€‚"; print_separator; return; fi

    local i=1
    for session_file in "${sessions_list[@]}"; do
        local filename title
        filename=$(basename "$session_file")
        if [[ "$filename" =~ session_[0-9]+_(.+)\.json ]]; then
            title="${BASH_REMATCH[1]}"; title=${title//_/ }
        else
            title="(æ–°ä¼šè¯ï¼Œç­‰å¾…å‘½å)"
        fi
        local current_marker=" "; if [ "$session_file" = "$HISTORY_FILE" ]; then current_marker="*"; fi
        printf " %s [%2d] %s\n" "$current_marker" "$i" "$title"; ((i++))
    done; print_separator
}

switch_session() {
    list_sessions; local sessions_list=()
    while IFS= read -r file; do [[ -n "$file" ]] && sessions_list+=("$file"); done < \
        <(find "$SESSIONS_DIR" -type f -name "*.json" -printf "%T@ %p\n" | sort -nr | cut -d' ' -f2-)
    if [ ${#sessions_list[@]} -eq 0 ]; then return; fi
    read -p "${PREFIX_SYSTEM} è¯·è¾“å…¥è¦åˆ‡æ¢çš„ä¼šè¯ç¼–å·: " choice
    if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le ${#sessions_list[@]} ]; then
        local target_session=${sessions_list[$((choice-1))]}
        echo "$target_session" > "$CURRENT_SESSION_POINTER"; HISTORY_FILE=$target_session
        clear; echo "${PREFIX_SYSTEM} å·²åˆ‡æ¢åˆ°ä¼šè¯ã€‚"; display_history
    else
        echo "${PREFIX_SYSTEM} æ— æ•ˆçš„é€‰æ‹©ã€‚"
    fi
}

delete_session() {
    list_sessions; local sessions_list=()
    while IFS= read -r file; do [[ -n "$file" ]] && sessions_list+=("$file"); done < \
        <(find "$SESSIONS_DIR" -type f -name "*.json" -printf "%T@ %p\n" | sort -nr | cut -d' ' -f2-)
    if [ ${#sessions_list[@]} -eq 0 ]; then return; fi
    read -p "${PREFIX_SYSTEM} è¯·è¾“å…¥è¦åˆ é™¤çš„ä¼šè¯ç¼–å·: " choice
    if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le ${#sessions_list[@]} ]; then
        local file_to_delete=${sessions_list[$((choice-1))]}
        read -p "${PREFIX_SYSTEM} ç¡®å®šè¦åˆ é™¤æ­¤ä¼šè¯å—ï¼Ÿ(y/N): " confirm
        if [[ "$confirm" =~ ^[yY](es)?$ ]]; then
            local was_current=false; if [ "$file_to_delete" = "$HISTORY_FILE" ]; then was_current=true; fi
            rm "$file_to_delete"
            if [ -f "$file_to_delete" ]; then echo "${PREFIX_SYSTEM} é”™è¯¯ï¼šæ— æ³•åˆ é™¤æ–‡ä»¶ã€‚"; else echo "${PREFIX_SYSTEM} ä¼šè¯å·²åˆ é™¤ã€‚"; fi
            if $was_current; then
                local remaining_sessions=()
                while IFS= read -r file; do [[ -n "$file" ]] && remaining_sessions+=("$file"); done < \
                    <(find "$SESSIONS_DIR" -type f -name "*.json" -printf "%T@ %p\n" | sort -nr | cut -d' ' -f2-)
                if [ ${#remaining_sessions[@]} -gt 0 ]; then
                    echo "${remaining_sessions[0]}" > "$CURRENT_SESSION_POINTER"; HISTORY_FILE=${remaining_sessions[0]}; echo "${PREFIX_SYSTEM} å·²è‡ªåŠ¨åˆ‡æ¢åˆ°æœ€è¿‘çš„ä¼šè¯ã€‚"
                else
                    new_session "initial"; echo "${PREFIX_SYSTEM} æ‰€æœ‰ä¼šè¯å‡å·²åˆ é™¤ï¼Œå·²ä¸ºæ‚¨åˆ›å»ºä¸€ä¸ªæ–°ä¼šè¯ã€‚"
                fi; clear; display_history
            fi
        else
            echo "${PREFIX_SYSTEM} æ“ä½œå·²å–æ¶ˆã€‚"
        fi
    else
        echo "${PREFIX_SYSTEM} æ— æ•ˆçš„é€‰æ‹©ã€‚"
    fi
}

# ==============================================================================
# å¯¹è¯ä¸å†å²è®°å½•å‡½æ•°
# ==============================================================================

clear_history() { if [ -f "$HISTORY_FILE" ]; then > "$HISTORY_FILE"; fi; echo "${PREFIX_SYSTEM} å½“å‰ä¼šè¯å†å²å·²æ¸…é™¤ã€‚"; }
set_system_prompt() {
    local new_prompt="$1"
    if [ -z "$new_prompt" ]; then echo "${PREFIX_SYSTEM} ç”¨æ³•: /system <æ–°çš„æç¤ºè¯å†…å®¹>"; return; fi
    echo "$new_prompt" > "$SYSTEM_PROMPT_FILE"; echo "${PREFIX_SYSTEM} ç³»ç»Ÿæç¤ºè¯å·²æ›´æ–°ã€‚"
}
get_system_prompt() { setup_environment; local p; p=$(cat "$SYSTEM_PROMPT_FILE"); echo "${PREFIX_SYSTEM} å½“å‰ç³»ç»Ÿæç¤ºè¯: ${COLOR_AI}$p${COLOR_RESET}"; }
display_history() {
    if [ ! -s "$HISTORY_FILE" ]; then return; fi
    print_separator; echo "${PREFIX_SYSTEM} æ­£åœ¨åŠ è½½å†å²å¯¹è¯..."
    jq -c '.[]' "$HISTORY_FILE" | while read -r msg; do
        role=$(jq -r '.role' <<< "$msg"); content=$(jq -r '.content' <<< "$msg")
        if [ "$role" == "user" ]; then echo "${PREFIX_USER} $content"; elif [ "$role" == "assistant" ]; then
            # å†å²è®°å½•ä¹Ÿä½¿ç”¨ Markdown æ¸²æŸ“
            if [ -n "$MD_RENDERER" ]; then
                echo "${PREFIX_AI}"; echo "$content" | $MD_RENDERER
            else
                echo "${PREFIX_AI} $content"
            fi
        fi
    done; print_separator
}

rename_session_with_title() {
    local first_prompt="$1"; local old_session_file="$2"; local title
    title=$(echo "$first_prompt" | head -c 30 | sed 's/[][\\/?"*|<>:[:space:]]/_/g')
    if [ -z "$title" ]; then title="chat"; fi
    local timestamp; timestamp=$(basename "$old_session_file" | cut -d'_' -f2 | cut -d'.' -f1)
    local new_session_file="${SESSIONS_DIR}/session_${timestamp}_${title}.json"
    if [ "$old_session_file" != "$new_session_file" ]; then
        mv "$old_session_file" "$new_session_file"
        echo "$new_session_file" > "$CURRENT_SESSION_POINTER"; HISTORY_FILE="$new_session_file"
    fi
}

# ==============================================================================
# èŠå¤©æ¨¡å¼
# ==============================================================================

temporary_chat() {
    local prompt="$1"
    if [ -z "$prompt" ]; then echo "${PREFIX_SYSTEM} é”™è¯¯: æœªæä¾›ä»»ä½•è¾“å…¥ã€‚" >&2; exit 1; fi
    local system_prompt; system_prompt=$(cat "$SYSTEM_PROMPT_FILE")
    local messages; messages=$(jq -n --arg sp "$system_prompt" --arg up "$prompt" \
        '[{"role": "system", "content": $sp}, {"role": "user", "content": $up}]')
    local json_payload; json_payload=$(jq -n --arg model "$MODEL" --argjson msgs "$messages" --argjson temp "$TEMPERATURE" \
        '{model: $model, messages: $msgs, temperature: $temp, stream: true}')

    local assistant_response_full=""
    # é™é»˜æ”¶é›†å“åº”
    while IFS= read -r line; do
        if [[ "$line" == "data: "* ]]; then line=${line#data: }; fi; if [ "$line" = "[DONE]" ]; then break; fi
        if [ -n "$line" ]; then
            chunk=$(echo "$line" | jq -r '(.choices[0].delta.content // .choices[0].text // "")')
            assistant_response_full+="$chunk"
        fi
    done < <(curl -s -N -X POST "$API_URL" -H "Content-Type: application/json" -H "Authorization: Bearer $API_KEY" -d "$json_payload")

    # æ”¶é›†å®Œæ¯•åï¼Œä¸€æ¬¡æ€§æ¸²æŸ“
    if [ -n "$assistant_response_full" ]; then
        if [ -n "$MD_RENDERER" ]; then
            echo "$assistant_response_full" | $MD_RENDERER
        else
            echo "$assistant_response_full"
        fi
    fi
}

interactive_chat() {
    clear; echo "${COLOR_AI}ä½ å¥½ï¼æ¬¢è¿ä½¿ç”¨ gchatã€‚è¾“å…¥ /help æŸ¥çœ‹å¯ç”¨å‘½ä»¤ã€‚${COLOR_RESET}"; display_history
    while true; do
        read -e -p "${PREFIX_USER} " USER_PROMPT; history -s "$USER_PROMPT"
        case "$USER_PROMPT" in
            "/exit" | "/quit") echo "${PREFIX_SYSTEM} å†è§ï¼"; break ;;
            "/clear") clear; clear_history; continue ;;
            "/system "*) set_system_prompt "${USER_PROMPT#*/system }"; continue ;;
            "/system") set_system_prompt ""; continue ;;
            "/getsystem" | "/gs") get_system_prompt; continue ;;
            "/help") show_interactive_help; continue ;;
            "/new") new_session; continue ;;
            "/list"|"/ls") list_sessions; continue ;;
            "/switch") switch_session; continue ;;
            "/delete") delete_session; continue ;;
            "") continue ;;
        esac

        local is_new_session=false; if [ ! -s "$HISTORY_FILE" ]; then is_new_session=true; fi
        local system_prompt history_messages messages json_payload
        system_prompt=$(cat "$SYSTEM_PROMPT_FILE"); history_messages="[]"
        if [ -s "$HISTORY_FILE" ]; then history_messages=$(jq -c '.' "$HISTORY_FILE"); fi
        messages=$(jq -n --argjson hist "$history_messages" --arg sp "$system_prompt" --arg up "$USER_PROMPT" \
            '[{"role": "system", "content": $sp}] + $hist + [{"role": "user", "content": $up}]')
        json_payload=$(jq -n --arg model "$MODEL" --argjson msgs "$messages" --argjson temp "$TEMPERATURE" \
            '{model: $model, messages: $msgs, temperature: $temp, stream: true}')

        local assistant_response_full=""

        # æ˜¾ç¤ºåŠ è½½åŠ¨ç”»ï¼ŒåŒæ—¶åœ¨åå°æ”¶é›†æ•°æ®
        spinner &
        SPINNER_PID=$!
        trap 'kill $SPINNER_PID 2>/dev/null; printf "\b \b"; trap - RETURN' RETURN

        while IFS= read -r line; do
            if [[ "$line" == "data: "* ]]; then line=${line#data: }; fi; if [[ "$line" == "[DONE]"* ]]; then break; fi
            if [[ -n "$line" ]]; then
                chunk=$(echo "$line" | jq -r '(.choices[0].delta.content // .choices[0].text // "")')
                # åªç´¯åŠ ï¼Œä¸å®æ—¶æ‰“å°
                assistant_response_full+="$chunk"
            fi
        done < <(curl -s -N -X POST "$API_URL" -H "Content-Type: application/json" -H "Authorization: Bearer $API_KEY" -d "$json_payload")

        # å“åº”æ¥æ”¶å®Œæ¯•ï¼Œåœæ­¢åŠ è½½åŠ¨ç”»
        kill $SPINNER_PID 2>/dev/null; printf "\b \b"
        trap - RETURN

        # æ ¹æ®æ˜¯å¦æœ‰æ¸²æŸ“å™¨ï¼Œå†³å®šæœ€ç»ˆçš„è¾“å‡ºæ–¹å¼
        if [ -n "$assistant_response_full" ]; then
            if [ -n "$MD_RENDERER" ]; then
                echo "${PREFIX_AI}" # å…ˆæ‰“å° AI å‰ç¼€
                echo "$assistant_response_full" | $MD_RENDERER # ç„¶åæ¸²æŸ“å®Œæ•´å†…å®¹
            else
                echo "${PREFIX_AI} ${assistant_response_full}" # å›é€€åˆ°çº¯æ–‡æœ¬è¾“å‡º
            fi

            # ä¿å­˜å¯¹è¯
            local updated_history
            updated_history=$(jq -n --argjson hist "$history_messages" --arg up "$USER_PROMPT" --arg ar "$assistant_response_full" \
                '$hist + [{"role": "user", "content": $up}, {"role": "assistant", "content": $ar}]')
            echo "$updated_history" | jq '.' >"$HISTORY_FILE"
            if $is_new_session; then rename_session_with_title "$USER_PROMPT" "$HISTORY_FILE"; fi
        else
            echo "${PREFIX_SYSTEM} è­¦å‘Šï¼šæœªèƒ½ä» API è·å–æœ‰æ•ˆå“åº”ã€‚è¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œã€API_URL å’Œ API_KEYã€‚"
        fi
    done
}

# ==============================================================================
# è„šæœ¬å…¥å£
# ==============================================================================

check_dependencies
setup_environment
detect_markdown_renderer

if [ "$#" -gt 0 ] && [[ "$1" != -* ]]; then
    temporary_chat "$*"; exit 0
elif ! [ -t 0 ]; then
    temporary_chat "$(cat -)"; exit 0
fi

if [ "$#" -gt 0 ]; then
    case "$1" in
        -h | --help) usage ;;
        -c | --clear) clear_history; exit 0 ;;
        -s | --system) if [ -z "$2" ]; then echo "é”™è¯¯: --system é€‰é¡¹éœ€è¦ä¸€ä¸ªå‚æ•°ã€‚" >&2; usage; fi; set_system_prompt "$2"; exit 0 ;;
        -gs | --getsystem) get_system_prompt; exit 0 ;;
        *) echo "é”™è¯¯: æœªçŸ¥é€‰é¡¹ '$1'ã€‚" >&2; usage ;;
    esac
fi

interactive_chat
exit 0
