#! /bin/node
const os = require('os');
/**
 * è·å–æœ¬æœºçš„ä¸»è¦ IPv4 åœ°å€
 * @returns {string | null} è¿”å›æ‰¾åˆ°çš„ç¬¬ä¸€ä¸ªéå†…éƒ¨ IPv4 åœ°å€ï¼Œå¦‚æœæ‰¾ä¸åˆ°åˆ™è¿”å› null
 */
function getLocalIPv4Address() {
  // è·å–æ‰€æœ‰ç½‘ç»œæ¥å£çš„ä¿¡æ¯
  // os.networkInterfaces() è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œé”®æ˜¯ç½‘ç»œæ¥å£çš„åç§°ï¼ˆä¾‹å¦‚ 'Wi-Fi', 'ä»¥å¤ªç½‘', 'eth0', 'en0' ç­‰ï¼‰ï¼Œ
  // å€¼æ˜¯ä¸€ä¸ªåŒ…å«è¯¥æ¥å£åˆ†é…çš„ç½‘ç»œåœ°å€ä¿¡æ¯çš„æ•°ç»„ã€‚
  const networkInterfaces = os.networkInterfaces();

  // éå†æ‰€æœ‰ç½‘ç»œæ¥å£åç§°
  for (const interfaceName of Object.keys(networkInterfaces)) {
    const interfaceInfoArray = networkInterfaces[interfaceName];

    // æ£€æŸ¥è¯¥æ¥å£ä¿¡æ¯æ˜¯å¦å­˜åœ¨ï¼ˆä»¥é˜²ä¸‡ä¸€ï¼‰
    if (!interfaceInfoArray) {
      continue;
    }

    // éå†è¯¥æ¥å£ä¸‹çš„æ‰€æœ‰ç½‘ç»œåœ°å€ä¿¡æ¯
    for (const networkInfo of interfaceInfoArray) {
      // ç­›é€‰æ¡ä»¶ï¼š
      // 1. family === 'IPv4': æˆ‘ä»¬åªå…³å¿ƒ IPv4 åœ°å€ã€‚
      // 2. !networkInfo.internal: æˆ‘ä»¬éœ€è¦æ’é™¤å†…éƒ¨å›ç¯åœ°å€ (ä¾‹å¦‚ 127.0.0.1)ã€‚
      if (networkInfo.family === 'IPv4' && !networkInfo.internal) {
        // æ‰¾åˆ°ç¬¬ä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„ IPv4 åœ°å€ï¼Œç«‹å³è¿”å›å®ƒ
        return networkInfo.address;
      }
    }
  }

  // å¦‚æœéå†å®Œæ‰€æœ‰æ¥å£éƒ½æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ IPv4 åœ°å€ï¼Œåˆ™è¿”å› null
  return null;
}



// è°ƒç”¨å‡½æ•°å¹¶æ‰“å°ç»“æœ
const localIP = getLocalIPv4Address();

if (localIP) {
  console.log('æœ¬æœº IPv4 åœ°å€æ˜¯:', localIP);
} else {
  console.log('æœªèƒ½æ‰¾åˆ°æœ¬æœºæœ‰æ•ˆçš„ IPv4 åœ°å€ã€‚');
}



// ä½ ä¹Ÿå¯ä»¥ç›´æ¥æŸ¥çœ‹æ‰€æœ‰æ¥å£ä¿¡æ¯ï¼ˆç”¨äºè°ƒè¯•ï¼‰
// console.log('æ‰€æœ‰ç½‘ç»œæ¥å£ä¿¡æ¯:', JSON.stringify(os.networkInterfaces(), null, 2));


// å¦‚æœ Node ç‰ˆæœ¬ä½äº 18 æˆ–è€…ä¸ºäº†å€ŸåŠ©æ’ä»¶å®ç°æ›´å¥½çš„ cookie å¤„ç†åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨ node-fetch
// npm install node-fetch
// const fetch = require('node-fetch');
// æˆ–è€…åœ¨ Node.js 18 åŠä»¥ä¸Šç‰ˆæœ¬ä¸­ä½¿ç”¨å†…ç½®çš„ fetch
const USERNAME = process.env.WIFI_USERNAME || ''; // ä½ çš„ç”¨æˆ·å
const PASSWORD = process.env.WIFI_PASSWORD || ''; // ä½ çš„å¯†ç 
console.log(`name:${USERNAME}\npassword: ${PASSWORD}`)

// é‡è¦ï¼šè¿™æ˜¯è¿æ¥æ—¶æµè§ˆå™¨è¢«é‡å®šå‘åˆ°çš„ *åˆå§‹* URLã€‚
// æ¯æ¬¡è¿æ¥æ—¶ä½ éƒ½å¿…é¡»å‡†ç¡®æ•è·è¿™ä¸ª URLï¼Œå› ä¸ºå‚æ•°ä¼šå‘ç”Ÿå˜åŒ–ã€‚
// è¿™ä¸ªç¤ºä¾‹ä½¿ç”¨äº†ä½ åœ¨è¯·æ±‚ 1 ä¸­çš„ URLã€‚
const initialPortalUrl = 'http://10.255.254.2:8080/zportal/login?wlanuserip=e7a30798078947db15aaac5ada1af2e7&wlanacname=b9d0aa678bd9a71f194f856b98cc8ec9&ssid=&nasip=f8338d22ad27527275597d58b3ce791a&snmpagentip=&mac=95be74234126dbca9b4db69073ee421b&t=wireless-v2&url=2ce30b22dbc76348b754dd5aab6128cd17f1020b58d879f1d091f86440fac969&apmac=&nasid=b9d0aa678bd9a71f194f856b98cc8ec9&vid=e76ab5a0fa88831c&port=3b50fdafa83396fd&nasportid=a25b45948c15af401e35fb57707478cf245acfd00ddc60834c1494d8934c997f ';

// ä¸ºäº†æ–¹ä¾¿è®¾ç½®çš„åŸºç¡€ URL
const baseUrl = 'http://10.255.254.2:8080';

// åœ¨è¿™é‡Œå­˜å‚¨ cookies
let cookies = {};

// è¾…åŠ©å‡½æ•°ï¼Œç”¨äºè§£æ Set-Cookie å¤´éƒ¨å¹¶æ›´æ–°æˆ‘ä»¬çš„ cookie å­˜å‚¨
function updateCookies(responseHeaders) {
    // `getSetCookie` æ˜¯ WHATWG Fetch æ ‡å‡† Headers ä¸­çš„ç°ä»£æ–¹æ³•
    // æ£€æŸ¥ç¯å¢ƒæ˜¯å¦æ”¯æŒå®ƒï¼Œå¦åˆ™ä½¿ç”¨å›é€€æ–¹æ³•
    let setCookieValues = [];
    if (typeof responseHeaders.getSetCookie === 'function') {
        setCookieValues = responseHeaders.getSetCookie();
    } else {
        // å¯¹äºä¸æ”¯æŒ getSetCookie çš„ç¯å¢ƒï¼ˆæ¯”å¦‚æ—§ç‰ˆæœ¬çš„ node-fetchï¼‰çš„å›é€€æ–¹æ³•
        // å¦‚æœå­˜åœ¨å¤šä¸ªåŒåå¤´éƒ¨ï¼Œè¿™å¯èƒ½ä¼šé”™è¯¯åœ°åˆå¹¶ cookiesã€‚
        const rawHeaders = responseHeaders.raw? responseHeaders.raw()['set-cookie'] : responseHeaders.get('set-cookie');
        if (rawHeaders) {
            setCookieValues = Array.isArray(rawHeaders)? rawHeaders : [rawHeaders];
        }
    }

    console.log("æ¥æ”¶åˆ°çš„åŸå§‹ Set-Cookie å¤´éƒ¨:", setCookieValues);

    setCookieValues.forEach(cookieString => {
        const parts = cookieString.split(';')[0].split('=');
        if (parts.length >= 2) {
            const key = parts[0].trim();
            const value = parts.slice(1).join('=').trim();
            // ä»…å½“é”®ç›¸å…³æ—¶æ‰æ›´æ–°ï¼ˆJSESSIONID æˆ–å¯èƒ½çš„å…¶ä»–é”®ï¼‰
            // ä½ å¯èƒ½éœ€è¦æ ¹æ®è§‚å¯Ÿåˆ°çš„ cookies æ¥ä¼˜åŒ–è¿™ä¸ªé€»è¾‘
            if (key === 'JSESSIONID' || key === 'userIndex') { // å¦‚æœéœ€è¦ï¼Œæ·»åŠ å…¶ä»–é‡è¦çš„é”®
                console.log(` ---> æ›´æ–° cookie: ${key}=${value}`);
                cookies[key] = value;
            }
        }
    });
}

// è¾…åŠ©å‡½æ•°ï¼Œç”¨äºæ ¼å¼åŒ–è¯·æ±‚å¤´ä¸­çš„ Cookie
function getCookieHeaderString() {
    // ç›®å‰ä½¿ç”¨ POST æ•è·ä¸­çš„ç‰¹å®š userIndexï¼Œå› ä¸ºå…¶æ¥æºä¸æ¸…æ¥š
    // å¦‚æœæœåŠ¡å™¨ç¡®å®åœ¨æ›´æ—©çš„æ—¶å€™è®¾ç½®äº† userIndexï¼ŒupdateCookies å‡½æ•°åº”è¯¥ä¼šæ•è·åˆ°å®ƒã€‚
    // å¦‚æœæ²¡æœ‰ï¼Œæˆ‘ä»¬å°±ä½¿ç”¨æ•è·åˆ°çš„å€¼ã€‚å¦‚æœæœ‰å¯ç”¨çš„ï¼Œä¼˜å…ˆä½¿ç”¨æœåŠ¡å™¨è®¾ç½®çš„å€¼ã€‚
    if (!cookies['userIndex']) {
        console.log("åœ¨æœåŠ¡å™¨å“åº”ä¸­æœªæ‰¾åˆ° userIndexï¼Œä½¿ç”¨æ•è·çš„å€¼ã€‚");
        cookies['userIndex'] = `"10.255.255.3,${localIP},${USERNAME}"`; // æ¥è‡ªä½ çš„ POST æ•è·
    }

    // å¦‚æœçœ‹èµ·æ¥æœ‰å¿…è¦ï¼Œæ·»åŠ ä½ æ•è·çš„å…¶ä»–é™æ€ cookies
    const staticCookies = {
        username: USERNAME,
        password: PASSWORD, // æ³¨æ„ï¼šåœ¨ cookie ä¸­å‘é€å¯†ç æ˜¯ä¸å¸¸è§çš„ï¼Œä½†åœ¨ä½ çš„æ—¥å¿—ä¸­å­˜åœ¨
        rememberPassword: 'true',
        failCounter: '0',
        serviceId: ''
    };

    const allCookies = {...staticCookies, ...cookies}; // å¦‚æœåç§°å†²çªï¼ŒæœåŠ¡å™¨è®¾ç½®çš„ cookies ä¼šè¦†ç›–é™æ€çš„ cookies

    return Object.entries(allCookies)
      .map(([key, value]) => `${key}=${value}`)
      .join('; ');
}

// è¾…åŠ©å‡½æ•°ï¼Œç”¨äºä» URL ä¸­æå–å‚æ•°
function getUrlParams(urlString) {
    const url = new URL(urlString);
    return url.searchParams;
}

async function runLogin() {
    try {
        const initialParams = getUrlParams(initialPortalUrl);
        console.log("è§£æäº†åˆå§‹ URL å‚æ•°ã€‚");

        // --- æ­¥éª¤ 1ï¼šåˆå§‹ GET è¯·æ±‚åˆ° /zportal/login?... ---
        console.log("\n--- æ­¥éª¤ 1ï¼šåˆå§‹ GET è¯·æ±‚ ---");
        console.log("URL:", initialPortalUrl);
        const response1 = await fetch(initialPortalUrl, {
            method: 'GET',
            headers: { // æ¨¡ä»¿ä½ åœ¨è¯·æ±‚ 1 ä¸­çš„æµè§ˆå™¨å¤´éƒ¨
                'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7',
                'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6',
                'Connection': 'keep-alive',
                'Host': '10.255.254.2:8080',
                'Upgrade-Insecure-Requests': '1',
                'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/135.0.0.0 Safari/537.36 Edg/135.0.0.0'
                // é€šå¸¸åœ¨ç¬¬ä¸€ä¸ªè¯·æ±‚ä¸­æ²¡æœ‰ Cookie å¤´éƒ¨
            },
            redirect: 'manual' // é‡è¦ï¼šé˜²æ­¢è‡ªåŠ¨é‡å®šå‘ä»¥æ•è·å¤´éƒ¨
        });

        console.log(`å“åº” 1 çŠ¶æ€ç : ${response1.status}`);
        updateCookies(response1.headers); // æå– JSESSIONID

        if (response1.status!== 302) {
            throw new Error(`æ­¥éª¤ 1 å¤±è´¥ï¼šé¢„æœŸçŠ¶æ€ç  302ï¼Œä½†å¾—åˆ°äº† ${response1.status}`);
        }

        const locationHeader = response1.headers.get('Location');
        if (!locationHeader) {
            throw new Error("æ­¥éª¤ 1 å¤±è´¥ï¼šåœ¨ 302 å“åº”ä¸­æœªæ‰¾åˆ° Location å¤´éƒ¨ã€‚");
        }

        // æ„å»ºå®Œæ•´çš„é‡å®šå‘ URL
        const redirectUrl = new URL(locationHeader, baseUrl).toString();
        console.log("é‡å®šå‘åˆ°:", redirectUrl);

        // --- æ­¥éª¤ 2ï¼šè·Ÿéšé‡å®šå‘ GET è¯·æ±‚åˆ° /zportal/loginForWeb?... ---
        console.log("\n--- æ­¥éª¤ 2ï¼šè·Ÿéšé‡å®šå‘ï¼ˆGETï¼‰---");
        const cookieHeader1 = getCookieHeaderString();
        console.log("ä½¿ç”¨çš„ Cookies:", cookieHeader1);
        const response2 = await fetch(redirectUrl, {
            method: 'GET',
            headers: { // æ¨¡ä»¿ä½ åœ¨è¯·æ±‚ 2 ä¸­çš„æµè§ˆå™¨å¤´éƒ¨
                'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7',
                'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6',
                'Connection': 'keep-alive',
                'Host': '10.255.254.2:8080',
                'Upgrade-Insecure-Requests': '1',
                'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/135.0.0.0 Safari/537.36 Edg/135.0.0.0',
                'Cookie': cookieHeader1 // å‘é€ JSESSIONID
            }
            // å¦‚æœéœ€è¦ï¼Œåœ¨è¿™é‡Œå…è®¸ fetch è‡ªåŠ¨å¤„ç†é‡å®šå‘ï¼Œæˆ–è€…ä¿æŒæ‰‹åŠ¨å¤„ç†
        });

        console.log(`å“åº” 2 çŠ¶æ€ç : ${response2.status}`);
        updateCookies(response2.headers); // å¦‚æœè®¾ç½®äº†æ–°çš„ cookiesï¼Œåˆ™æ›´æ–° cookies

        if (!response2.ok) { // æ£€æŸ¥ 2xx çŠ¶æ€ç 
            console.warn(`æ­¥éª¤ 2 è­¦å‘Šï¼šçŠ¶æ€ç ä¸º ${response2.status}ã€‚å°è¯•ç»§ç»­...`);
            // æ ¹æ®é—¨æˆ·çš„æƒ…å†µï¼Œå¦‚æœè®¾ç½®äº† cookiesï¼Œè¿™é‡Œçš„é 200 çŠ¶æ€ç å¯èƒ½æ˜¯å¯ä»¥æ¥å—çš„ã€‚
        }
        // æˆ‘ä»¬ä¸ä¸€å®šä¸¥æ ¼éœ€è¦å“åº”ä½“ï¼Œä½†å¯ä»¥ä¸ºäº†è°ƒè¯•è€Œè®°å½•å®ƒ
        // const body2 = await response2.text();
        // console.log("å“åº” 2 ä¸»ä½“ï¼ˆç™»å½•é¡µé¢ HTML - ç‰‡æ®µï¼‰:", body2.substring(0, 200));

        // --- æ­¥éª¤ 3ï¼šå¯é€‰çš„ GET è¯·æ±‚åˆ° /zportal/goToAuthResult ---
        console.log("\n--- æ­¥éª¤ 3ï¼šå¯é€‰çš„ GET è¯·æ±‚ï¼ˆgoToAuthResultï¼‰---");
        const authResultUrl = `${baseUrl}/zportal/goToAuthResult`;
        const cookieHeader2 = getCookieHeaderString(); // è·å–å¯èƒ½æ›´æ–°çš„ cookies
        console.log("ä½¿ç”¨çš„ Cookies:", cookieHeader2);
        const response3 = await fetch(authResultUrl, {
            method: 'GET',
            headers: { // æ¨¡ä»¿ä½ åœ¨è¯·æ±‚ 3 ä¸­çš„æµè§ˆå™¨å¤´éƒ¨
                'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7',
                'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6',
                'Connection': 'keep-alive',
                'Host': '10.255.254.2:8080',
                'Referer': redirectUrl, // è®¾ç½® Referer ä¸ºç™»å½•é¡µé¢çš„ URL
                'Upgrade-Insecure-Requests': '1',
                'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/135.0.0.0 Safari/537.36 Edg/135.0.0.0',
                'Cookie': cookieHeader2 // å‘é€æ‰€æœ‰å·²çŸ¥çš„ cookies
            }
        });

        console.log(`å“åº” 3 çŠ¶æ€ç : ${response3.status}`);
        updateCookies(response3.headers); // å¦‚æœéœ€è¦ï¼Œå†æ¬¡æ›´æ–° cookies
        // const body3 = await response3.text();
        // console.log("å“åº” 3 ä¸»ä½“ï¼ˆç‰‡æ®µï¼‰:", body3.substring(0, 200));

        // --- æ­¥éª¤ 4ï¼šæäº¤ç™»å½• POST è¯·æ±‚ ---
        console.log("\n--- æ­¥éª¤ 4ï¼šæäº¤ç™»å½•ï¼ˆPOSTï¼‰---");

        // ä½¿ç”¨å›¾ç‰‡/åˆå§‹ URL ä¸­çš„å‚æ•°å‡†å¤‡è¡¨å•æ•°æ®
        const formData = new URLSearchParams();
        formData.append('qrCodeId', ''); // æ¥è‡ªå›¾ç‰‡çš„å€¼
        formData.append('username', USERNAME);
        formData.append('pwd', PASSWORD);
        formData.append('validCode', ''); // æ¥è‡ªå›¾ç‰‡çš„å€¼ï¼ˆä¸ºç©ºï¼‰
        formData.append('validCodeFlag', 'false'); // æ¥è‡ªå›¾ç‰‡çš„å€¼
        formData.append('ssid', initialParams.get('ssid') || ''); // ä½¿ç”¨åŸå§‹å‚æ•°æˆ–å›é€€å€¼
        formData.append('mac', initialParams.get('mac') || '95be74234126dbca9b4db69073ee421b'); // ä½¿ç”¨åŸå§‹/æ•è·çš„ mac
        formData.append('t', initialParams.get('t') || 'wireless-v2'); // ä½¿ç”¨åŸå§‹å‚æ•°æˆ–å›é€€å€¼
        formData.append('wlanacname', initialParams.get('wlanacname') || 'b9d0aa678bd9a71f194f856b98cc8ec9'); // ä½¿ç”¨åŸå§‹å‚æ•°æˆ–å›é€€å€¼
        formData.append('url', initialParams.get('url') || '2ce30b22dbc76348b754dd5aab6128cd17f1020b58d879f1d091f86440fac969'); // ä½¿ç”¨åŸå§‹å‚æ•°æˆ–å›é€€å€¼
        formData.append('nasip', initialParams.get('nasip') || 'f8338d22ad27527275597d58b3ce791a'); // ä½¿ç”¨åŸå§‹å‚æ•°æˆ–å›é€€å€¼
        // é‡è¦ï¼šä½¿ç”¨ *å›¾ç‰‡è¡¨å•æ•°æ®* ä¸­çš„ wlanuseripï¼Œå®ƒæœ‰æ—¶å¯èƒ½ä¸è¯·æ±‚ 1 URL ä¸­çš„ç•¥æœ‰ä¸åŒ
        formData.append('wlanuserip', 'e7a30798078947dbbc70b61764e2d474'); // æ¥è‡ªå›¾ç‰‡æ•°æ®

        const loginUrl = `${baseUrl}/zportal/login/do`;
        const cookieHeader3 = getCookieHeaderString(); // è·å–æœ€ç»ˆçš„ cookies é›†åˆ
        console.log("ä½¿ç”¨çš„ Cookies:", cookieHeader3);
        console.log("ä½¿ç”¨çš„è¡¨å•æ•°æ®:");
        for (let [key, value] of formData.entries()) {
            console.log(`  ${key}: ${value}`);
        }

        const response4 = await fetch(loginUrl, {
            method: 'POST',
            headers: { // æ¨¡ä»¿ä½ åœ¨ POST è¯·æ±‚ä¸­çš„æµè§ˆå™¨å¤´éƒ¨
                'Accept': '*/*',
                // 'Accept-Encoding': 'gzip, deflate', // è®© fetch å¤„ç†
                'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6',
                'Cache-Control': 'no-cache',
                'Connection': 'keep-alive',
                'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                'Cookie': cookieHeader3, // å‘é€æœ€ç»ˆçš„ cookies
                'Host': '10.255.254.2:8080',
                'Origin': baseUrl,
                'Pragma': 'no-cache',
                'Referer': redirectUrl, // Referer æ˜¯æ­¥éª¤ 2 ä¸­çš„ç™»å½•é¡µé¢ URL
                'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/135.0.0.0 Safari/537.36 Edg/135.0.0.0',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        });

        console.log(`å“åº” 4 çŠ¶æ€ç : ${response4.status}`);

        // --- æ­¥éª¤ 5ï¼šæ£€æŸ¥ç»“æœ ---
        console.log("\n--- æ­¥éª¤ 5ï¼šæ£€æŸ¥ç™»å½•ç»“æœ ---");
        if (!response4.ok) {
            console.error(`ç™»å½• POST è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç ä¸º: ${response4.status}`);
            try { // å°è¯•åœ¨å¯èƒ½çš„æƒ…å†µä¸‹è·å–é”™è¯¯è¯¦æƒ…
                const errorText = await response4.text();
                console.error("é”™è¯¯å“åº”ä¸»ä½“:", errorText);
            } catch (e) {
                console.error("æ— æ³•è¯»å–é”™è¯¯å“åº”ä¸»ä½“ã€‚");
            }
            throw new Error(`ç™»å½•å¤±è´¥ï¼ŒçŠ¶æ€ç ä¸º ${response4.status}`);
        }

        try {
            const resultData = await response4.json();
            console.log("ç™»å½•å“åº”æ•°æ®:", resultData);

            // **æ ¹æ®å®é™…çš„æˆåŠŸå“åº”è°ƒæ•´æ­¤æ£€æŸ¥**
            // å¸¸è§æ¨¡å¼ï¼šresult="success", code=0, status=true, msg="ç™»å½•æˆåŠŸ" ç­‰

            if (resultData && (resultData.result === 'success' || resultData.ret === 1 || resultData.ecode === 0 || resultData.message?.includes('æˆåŠŸ')||resultData.result?.includes('online'))) { // å¦‚æœéœ€è¦ï¼Œæ·»åŠ æ›´å¤šæˆåŠŸæ¡ä»¶
                console.log("\nâœ… ç™»å½•æˆåŠŸï¼");
            } else {
                console.error("\nâŒ ç™»å½•å¤±è´¥ã€‚æœåŠ¡å™¨å“åº”:", resultData.message || resultData.msg || JSON.stringify(resultData));
            }
        } catch (jsonError) {
            console.warn("å“åº”ä¸æ˜¯ JSON æ ¼å¼ã€‚å°è¯•ä»¥æ–‡æœ¬å½¢å¼è¯»å–...");
            const resultText = await response4.text();
            console.log("ç™»å½•å“åº”æ–‡æœ¬:", resultText);
            // å¦‚æœéœ€è¦ï¼Œæ·»åŠ åŸºäºæ–‡æœ¬çš„æˆåŠŸæ£€æŸ¥
            if (resultText.includes('success') || resultText.includes('online') || resultText.includes('æˆåŠŸ')) { // åŸºæœ¬æ£€æŸ¥
                console.log("\nâœ… ç™»å½•å¯èƒ½æˆåŠŸï¼ˆåŸºäºæ–‡æœ¬ï¼‰ã€‚");
            } else {
                console.error("\nâŒ ç™»å½•å¤±è´¥ï¼ˆæ— æ³•è§£æ JSONï¼Œæ–‡æœ¬æ£€æŸ¥å¤±è´¥ï¼‰ã€‚");
            }
        }

    } catch (error) {
        console.error("\nğŸ’¥ ç™»å½•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:", error);
    }
}

// è¿è¡Œç™»å½•æµç¨‹
runLogin();
